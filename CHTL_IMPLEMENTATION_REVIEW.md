# CHTL实现审查报告

## 审查日期：2024-12

基于CHTL语法文档对当前Java实现进行的全面审查。

## 1. 发现的主要问题

### 1.1 CHTL JS语法差异

#### 问题1：操作符不一致
- **语法文档**：使用 `->` 操作符（如 `{{box}}->listen(...)`）
- **当前实现**：使用 `.` 操作符（如 `{{box}}.listen(...)`）
- **影响**：语法不兼容

#### 问题2：箭头函数支持
- **语法文档**：显示了箭头函数语法 `() => {}`
- **当前实现**：明确不支持箭头函数
- **冲突**：需要确认是否应该支持

#### 问题3：参数解析顺序
- **要求**：CHTL JS函数参数应该是无序的，可选的
- **当前实现**：使用switch语句强制了特定顺序
- **需要修复**：应该支持任意顺序和组合的参数

### 1.2 增强选择器使用

#### 问题4：`&` vs `{{&}}` 混淆
- **正确用法**：
  - 局部样式块：使用 `&`
  - 局部脚本块：使用 `{{&}}`
- **文档错误**：多处文档错误地在style块中使用了`{{&}}`

### 1.3 模板系统

#### 问题5：全缀名支持
- **语法文档**：支持 `[Custom] @Element Box` 形式的全缀名
- **需要验证**：当前实现是否支持这种语法

#### 问题6：Template vs Custom理解错误
- **语法文档**：
  - `[Template]`：用于模板定义（不可特例化）
  - `[Custom]`：用于自定义（可特例化，更灵活）
- **当前实现**：正确使用了`[Template]`
- **状态**：无需修改，但需要实现`[Custom]`功能

## 2. 需要实现的功能

### 2.1 配置组支持
```chtl
[Configuration]
{
    INDEX_INITIAL_COUNT = 0;
    DISABLE_NAME_GROUP = true;
    DEBUG_MODE = false;
    
    [Name]
    {
        CUSTOM_STYLE = [@Style, @style, @CSS, @Css, @css];
        CUSTOM_ELEMENT = @Element;
        CUSTOM_VAR = @Var;
    }
}
```

### 2.2 原始嵌入支持
```chtl
[Origin] @Html { ... }
[Origin] @Style { ... }
[Origin] @JavaScript { ... }
```

### 2.3 animate函数完整参数
- `duration`：持续时间
- `easing`：缓动函数（unquoted literal）
- `begin`：起始状态
- `end`：结束状态
- `when`：关键帧数组
- `loop`：循环次数
- `direction`：播放方向
- `delay`：延迟
- `callback`：回调函数

### 2.4 delegate函数语法
```chtl
{{父元素}}->delegate({
    target: {{选择器}} | [{{选择器1}}, {{选择器2}}],
    click: 函数,
    mouseenter: 函数
});
```

## 3. 需要修复的实现

### 3.1 CHTLJSParser
1. 将 `.` 操作符改为 `->`
2. 支持参数的无序解析
3. 考虑是否支持箭头函数

### 3.2 Scanner/Lexer
1. 识别 `->` 操作符
2. 正确区分 `&` 和 `{{&}}`

### 3.3 模板系统
1. 确认 `[Template]` vs `[Custom]` 的使用
2. 支持全缀名访问

## 4. 建议的修改优先级

### 高优先级
1. 修复 `->` 操作符支持
2. 实现参数无序解析
3. 修正 `&` 和 `{{&}}` 的使用

### 中优先级
1. 实现配置组功能
2. 支持原始嵌入
3. 完善animate函数参数

### 低优先级
1. 支持全缀名
2. 优化错误提示
3. 性能优化

## 5. 兼容性考虑

由于这些改动会影响语法兼容性，建议：
1. 提供迁移指南
2. 支持旧语法的兼容模式（可选）
3. 明确版本要求

## 6. 测试需求

需要更新或添加的测试：
1. `->` 操作符解析测试
2. 参数无序性测试
3. `&` vs `{{&}}` 使用测试
4. 配置组解析测试
5. 原始嵌入测试
6. `[Custom]`特例化测试

## 7. 其他发现的问题

### 7.1 Import语法
- **语法文档**：`[Import] [Custom] @Element 名称 from 路径`
- **需要验证**：当前是否支持这种导入语法

### 7.2 约束系统
- **except约束**：`except span, [Custom] @Element Box;`
- **类型约束**：`except @Html;`
- **需要验证**：约束系统的完整性

### 7.3 命名空间
- **语法文档**：支持嵌套命名空间
- **需要验证**：命名空间系统的实现程度

## 8. 审查总结

### 已实现但需要修正的功能
1. CHTL JS操作符（`.` → `->`）
2. 参数解析顺序（需要支持无序）
3. 文档中`&`和`{{&}}`的混淆

### 未实现的重要功能
1. `[Custom]`自定义系统
2. `[Configuration]`配置组
3. `[Origin]`原始嵌入
4. 完整的约束系统
5. `delegate`函数

### 建议的行动计划
1. **立即修复**：操作符问题和参数解析
2. **短期目标**：实现`[Custom]`系统
3. **中期目标**：完善配置组和原始嵌入
4. **长期目标**：优化性能和错误处理